<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>The Woes of WebSockets</title>
  <meta name="description" content="Lately I’ve been developing a server side implementation of Web Socket Protocol and I must say even though the core concept of Web Socket protocol is awesome...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://unknownland.github.io/2014/03/26/the-woes-of-websockets/">
  <link rel="alternate" type="application/rss+xml" title="_UnKn0wN LaNd_" href="http://unknownland.github.io/feed.xml">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">_UnKn0wN LaNd_</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">The Woes of WebSockets</h1>
    <p class="post-meta"><time datetime="2014-03-26T12:49:00+05:30" itemprop="datePublished">Mar 26, 2014</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Lately I’ve been developing a server side implementation of <a href="https://tools.ietf.org/html/rfc6455">Web Socket Protocol</a> and I must say even though the core concept of Web Socket protocol is awesome, its framing specification has got it all wrong. Let’s start with the definition of a Web Socket frame.</p>

<div class="highlighter-rouge"><pre class="highlight"><code> 0                   1                   2                   3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-------+-+-------------+-------------------------------+
 |F|R|R|R| opcode|M| Payload len |    Extended payload length    |
 |I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |
 |N|V|V|V|       |S|             |   (if payload len==126/127)   |
 | |1|2|3|       |K|             |                               |
 +-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +
 |     Extended payload length continued, if payload len == 127  |
 + - - - - - - - - - - - - - - - +-------------------------------+
 |                               |Masking-key, if MASK set to 1  |
 +-------------------------------+-------------------------------+
 | Masking-key (continued)       |          Payload Data         |
 +-------------------------------- - - - - - - - - - - - - - - - +
 :                     Payload Data continued ...                :
 + - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +
 |                     Payload Data continued ...                |
 +---------------------------------------------------------------+
</code></pre>
</div>

<p>As you can see above, it is a total mess. My biggest complain is about the masking of frame’s payload when they are sent from a client to a server. The purpose of this masking is to prevent <a href="https://tools.ietf.org/html/rfc6455#page-51">cache poisoning in proxies</a>. But what does cache poisoning got to do with the Web Socket protocol? It is a vulnerability found on really old out-of-date proxies and why does Web Socket protocol has to pay the price for that?</p>

<p>The real problem occurs when unmasking the frame’s payload. You have to XOR the masked payload with the mask key and need I remind you that XORing is CPU intensive when you have to unmask thousands of frames per minute. Why don’t we just let those old proxies suffer the cache poisoning (proxy users could either upgrade to a new version or the proxy vendor could release a patch for this particular vulnerability) and rid the Web Sockets from this misery of masking.</p>

<p>The next problem is the payload length. 64 bits can be to specify the number of bytes in the payload. That means 2^64 = <a href="http://www.wolframalpha.com/input/?i=2%5E64">18 quintillion</a>, which is more bytes than the <a href="http://www.wolframalpha.com/input/?i=number+of+stars+in+the+Milky+Way+galaxy">number of stars in the Milky Way galaxy</a>. Is it really practical to use such a large payload? Apart from that, there is another feature of continuous frames to handle such scenario.</p>

<p>Let’s use a fixed size of 4 bytes(size of an integer) to specify the payload length. If the payload is larger than that, one could use the continuous framing mechanism. Having a fixed number of bytes to represent the payload length is always better than a dynamic size.</p>

<p>After applying above improvements, I present you a more practical definition of a Web Socket frame as below. What do you think about it?</p>

<div class="highlighter-rouge"><pre class="highlight"><code> 0                   1                   2                   3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-------+-+-------------+-------------------------------+
 |F|R|R|R| opcode|         Payload length (Fixed Size)           |
 |I|S|S|S|  (4)  |                  (32)                         |
 |N|V|V|V|       |                                               |
 | |1|2|3|       |                                               |
 +-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +
 |Payload length |          Payload Data                         |
 +-------------------------------- - - - - - - - - - - - - - - - +
 :                     Payload Data continued ...                :
 + - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +
 |                     Payload Data continued ...                |
 +---------------------------------------------------------------+
</code></pre>
</div>

  </div>
  <div class="wrapper">
        <div id="disqus_thread"></div> <script type="text/javascript"> var disqus_shortname = 'sajithblog'; var disqus_url = 'http://unknownland.github.io/2014/03/26/the-woes-of-websockets/'; var disqus_identifier = 'http://unknownland.github.io/2014/03/26/the-woes-of-websockets/'; var disqus_title = 'The Woes of WebSockets'; (function () { var s = document.createElement('script'); s.async = true; s.type = 'text/javascript'; s.src = '//sajithblog.disqus.com/embed.js'; (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s); }()); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>

</article>

      </div>
  <!--     <div class="wrapper">
      <a href="https://twitter.com/share" class="twitter-share-button" data-count="none" data-url="http://unknownland.github.io/2014/03/26/the-woes-of-websockets/" data-text="The Woes of WebSockets by @sajithdilshan -" data-dnt="true">Twitter</a> <div class="fb-like" data-href="http://unknownland.github.io/2014/03/26/the-woes-of-websockets/" data-layout="button" data-action="like" data-show-faces="false" data-colorscheme="light" data-kid-directed-site="false" data-share="false"></div> <a class="facebook-share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://unknownland.github.io/2014/03/26/the-woes-of-websockets/" title="Share on Facebook">Facebook</a> 
      </div> -->
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">_UnKn0wN LaNd_</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-3">
        <ul class="contact-list">
          <li><a href="mailto:sajithdilshan@gmail.com">sajithdilshan@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/sajithdilshan"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">sajithdilshan</span></a>

          </li>
          

          
        </ul>
      </div>

    
    </div>

  </div>

</footer>


  </body>

</html>
